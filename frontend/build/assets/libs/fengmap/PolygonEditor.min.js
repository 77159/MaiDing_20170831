(function(g){function f(a){this.map=a.map;this.config=a||{};this.object=this.config.object;this.container=this.map.options.container;this.raycaster=new fm.Raycaster;this.plane=new fm.Mesh(new fm.PlaneGeometry(1E4,1E4,1,1),new fm.MeshBasicMaterial({visible:!1}));this.plane.rotateX(-Math.PI/2);this.plane.visible=!1;this.map.mapScene.getO3dScene().add(this.plane);this.clickCount=0;this.isTracking=!1;this._mouseDownFun=this.mouseDown.bind(this);this._mouseMoveFun=this.mouseMove.bind(this);this._mouseUpFun=
this.mouseUp.bind(this);this.addEvents()}f.prototype={constructor:f,addEvents:function(){var a=this.map.options.container;a.addEventListener("mousedown",this._mouseDownFun);a.addEventListener("mousemove",this._mouseMoveFun);a.addEventListener("mouseup",this._mouseUpFun);a.addEventListener("touchstart",this._mouseDownFun);a.addEventListener("touchmove",this._mouseMoveFun);a.addEventListener("touchend",this._mouseUpFun)},dispose:function(){this.stopTrack();var a=this.map.options.container;a.removeEventListener("mousedown",
this._mouseDownFun);a.removeEventListener("mousemove",this._mouseMoveFun);a.removeEventListener("mouseup",this._mouseUpFun);a.removeEventListener("touchstart",this._mouseDownFun);a.removeEventListener("touchmove",this._mouseMoveFun);a.removeEventListener("touchend",this._mouseUpFun);this.plane.parent.remove(this.plane);this.plane.geometry.dispose();this.plane.material.dispose()},getMouse:function(a){return fengmap.MapPicker.prototype.getPick_.call(this,a)},getPick:function(){this.raycaster.setFromCamera(this.currentPick,
this.map.currentCamera_);var a=this.raycaster.intersectObject(this.object||this.plane,!0);return 0<a.length?a[0]:null},updatePlaneHeight:function(a,e){e=void 0===e?2.1:e;a=this.map.getGroupHeight(a)+e;this.plane.position.y=a;this.plane.updateMatrixWorld()},abort:function(){this.config.mouseabort&&this.config.mouseabort();this.stopTrack()},mouseDown:function(a){if(this.isTracking)if(2===a.button)this.abort();else{this.isMouseDown=!0;this._lastPick=this.getMouse(a);this.currentPick=this._lastPick.clone();
var e=this.getPick(a);this.point=e.point;this.config.mousedown&&this.config.mousedown(e);a.preventDefault()}},mouseMove:function(a){if(this.isTracking){this.currentPick=this.getMouse(a);var e=this.getPick(a);this.point=e.point;this.config.mousemove&&this.config.mousemove(e);a.preventDefault()}},mouseUp:function(a){this.isTracking&&(this.isMouseDown=!1,this.clickCount++,this.config.mouseup&&this.config.mouseup(),a.preventDefault())},startTrack:function(){this.updatePlaneHeight(this.map.focusGroupID,
this.config.height);this.isTracking=!0;this.plane.visible=!0;this.map.mapPicker.enabled=!1;this.map.controls.enablePan=!1;this.map.controls.enableRotate=!1},stopTrack:function(){this.clickCount=0;this.isTracking=!1;this.plane.visible=!1;this.map.mapPicker.enabled=!0;this.map.controls.enablePan=!0;this.map.controls.enableRotate=!0}};g.FMMouseTrack=f})(this.fengmap=this.fengmap||{});
(function(g){function f(c){var b=document.createElement("canvas").getContext("2d");c=c||128;b.canvas.width=c;b.canvas.height=c;b.beginPath();b.arc(c/2,c/2,c/2-4,0,2*Math.PI,!0);b.fillStyle="white";b.globalAlpha=.5;b.fill();b.strokeStyle="white";b.globalAlpha=1;b.lineWidth=6;b.stroke();return new fm.CanvasTexture(b.canvas)}function a(c){this.config=c||{};this.config.height=this.config.height||2.1;this.map=this.config.map;e=this.config.color||e;this.mode="create";this.isStarted=!1;this.circle=fengmap.createCircleSprite(this.map,
32);this.circle.visible=!1;this.circle.material.depthTest=!1;this.circle.renderOrder=100;this.map.mapScene.o3dScene_.add(this.circle);this._md=this.mousedown.bind(this);this._mm=this.mousemove.bind(this);this._mu=this.mouseup.bind(this);this._ma=this.mouseabort.bind(this);this.mt=new fengmap.FMMouseTrack({map:this.map,mousedown:this._md,mousemove:this._mm,mouseup:this._mu,mouseabort:this._ma,height:this.config.height});this.points=[];this.vertices=[];this.lineStyle={lineWidth:2,color:e,offsetHeight:0,
lineType:"full",segments:2};this.polygonMarkerStyle={map:this.map,color:e,alpha:.5,lineWidth:1.5,height:this.config.height};this.linePs=[]}var e=2270702;g.createCircleSprite=function(c,b){b=b||128;var a=f(b),a=new fm.SpriteMaterial({map:a,color:e}),d=new fm.Sprite(a);d.update=function(){var a=fengmap.MapUtil.getSpriteScale(c,d);d._scale_=a;d.scale.setScalar(b*a/2)};d.setGreen=function(){d.material.color.setHex(65280)};d.setRed=function(){d.material.color.setHex(16711680)};d.setNormal=function(){d.material.color.setHex(e)};
c.on("update",d.update);d.dispose=function(){c.off("update",d.update);d.parent.remove(d);d.material.dispose();d.material.map.dispose()};return d};a.prototype={constructor:a,updateLine:function(a){this.line&&this.line.dispose();this.line=this.map.drawLineMark(a||this.points,this.lineStyle)},getPMLayer:function(){return this.map.getFMGroup(this.map.focusGroupID).getOrCreateLayer("polygonMarker")},updatePolygonMarker:function(a,b){var c="create"===this.mode?this.polygonMarker:this.snaped.pm;if(c)c.update({points:a});
else{var d=this.getPMLayer();this.polygonMarkerStyle.points=a;this.polygonMarker=new fengmap.FMPolygonMarker(this.polygonMarkerStyle);d.addMarker(this.polygonMarker);c=this.polygonMarker}c._ps=a.slice();c._vs=b.slice();c.getPoints||(c.getPoints=function(){return c._ps})},clearSnapPM:function(){this.snapPM&&(this.snapPM._lastColor?this.snapPM.setColor(this.snapPM._lastColor):this.snapPM.setColor(e),this.snapPM=null)},abort:function(){this.mt.abort()},mousedown:function(a){this.isMouseDown=!0;var b=
this.snapVec||a.point,b=b.clone();this._lastVec=a.point;"create"===this.mode?(b.index=this.vertices.length,this.vertices.push(b),this.points.push(this.map.toMapCoord(b)),3>this.mt.clickCount&&this.linePs.push(this.map.toMapCoord(b)),2===this.mt.clickCount&&(this.line.dispose(),this.linePs.length=0),2<this.points.length&&this.updatePolygonMarker(this.points,this.vertices)):"edit"===this.mode&&(this.clearSnapPM(),this.snaped=this._snaped)&&(this.snapPMs=this.getSnapPMs(this.snaped.pm.o3d_))},mousemove:function(a){var b=
this.snap(a.point),c=new fm.Vector3;this._snaped=null;b&&b.vec?(this.circle.setGreen(),this.snapVec=b.vec,this.circle.position.copy(b.vec),this._snaped=b):(this.circle.setNormal(),this.snapVec=null,this.circle.position.copy(a.point));if("create"===this.mode&&3>this.mt.clickCount){var d=this.linePs.slice();d.push(this.map.toMapCoord(this.snapVec||a.point));this.updateLine(d)}this.snaped&&this.isMouseDown&&"edit"===this.mode&&(c.copy(a.point.clone().sub(this._lastVec)),this._lastVec=a.point.clone(),
b=this.snaped,d=b.pm._ps,a=b.pm._vs,c=b.vec.add(c),this.snapVec&&(c=this.snapVec.clone(),c.index=b.vec.index),this.circle.position.copy(c),d[b.vec.index]=this.map.toMapCoord(c),a[b.vec.index]=c,this.updatePolygonMarker(d,a))},mouseup:function(a){this.isMouseDown=!1;"edit"===this.mode&&(this.snapPMs=this.getSnapPMs(),this.snaped&&this.config.callback&&this.config.callback(this.snaped.pm))},mouseabort:function(a){this.circle.visible=!1;this.points.length=0;this.vertices.length=0;this.line&&this.line.dispose();
"create"===this.mode&&this.polygonMarker&&this.config.callback(this.polygonMarker);this.clearSnapPM();this.polygonMarker=this.line=null;this.linePs.length=0;this.isStarted=!1},snap:function(a){if(this.snapPMs){for(var b={vec:null},c=0;c<this.snapPMs.length;c++){var d=this.snapPMs[c];if(d._vs){b.pm=d;for(var e=0;e<d._vs.length;e++){var f=d._vs[e];if(f.distanceTo(a)<10*this.circle._scale_)return b.vec=f,this.clearSnapPM(),d._lastColor=d.color,d.setColor(16158464),this.snapPM=d,b}}}this.clearSnapPM();
return b}},getSnapPMs:function(a){for(var b=this.getPMLayer().o3d_.children,c=[],d=0;d<b.length;d++){var e=b[d];e!==a&&c.push(e.fm_)}return c},start:function(a){this.abort();this.mode=a||"create";this.isStarted=!0;this.snaped=null;this.snapPMs=this.getSnapPMs();this.circle.visible=!0;this.mt.startTrack()},dispose:function(){this.mt.dispose();this.circle.parent.remove(this.circle);this.circle.material.dispose();this.circle.material.map.dispose()},getCenter:function(a,b){var c=b.reduce(function(a,b){return{x:a.x+
b.x,y:a.y+b.y,z:a.z}});return{x:c.x/b.length,y:c.y/b.length,z:c.z,groupID:a.focusGroupID}}};g.FMPolygonEditor=a})(this.fengmap=this.fengmap||{});